<!DOCTYPE html>
<html>
<head>
    <title>Player Debug Stats</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .timestamp { color: #666; margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>Player Statistics</h1>
    <div class="timestamp" id="lastUpdated"></div>
    <table id="playerTable">
        <thead>
            <tr>
                <th>Username</th>
                <th>Points</th>
                <th>Time Played (sec)</th>
                <th>Current Location</th>
            </tr>
        </thead>
        <tbody>
            <!-- Data will be inserted here -->
        </tbody>
    </table>
    <button onclick="refreshData()" style="margin-top: 20px; padding: 10px;">Refresh Data</button>

    <script>
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}m ${secs}s`;
        }

        function refreshData() {
            fetch('../PHP/getPlayerStats.php')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.querySelector('#playerTable tbody');
                    tbody.innerHTML = '';
                    
                    data.data.forEach(player => {
                        const row = `<tr>
                            <td>${player.username}</td>
                            <td>${player.points}</td>
                            <td>${formatTime(player.time_played)}</td>
                            <td>${player.current_page}</td>
                        </tr>`;
                        tbody.innerHTML += row;
                    });
                    
                    document.getElementById('lastUpdated').textContent = 
                        `Last updated: ${new Date().toLocaleString()}`;
                })
                .catch(error => console.error('Error:', error));
        }

        // Load data immediately and every 30 seconds
        refreshData();
        setInterval(refreshData, 30000);
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const debugData = JSON.parse(localStorage.getItem('debugData') || '[]');
            
            // Handle exit time updates
            window.addEventListener('message', (event) => {
                if (event.data.action === 'exit') {
                    const exitEntry = {
                        username: event.data.username,
                        exitTime: new Date(event.data.exitTime).toLocaleString(),
                        type: 'exit'
                    };
                    debugData.push(exitEntry);
                    localStorage.setItem('debugData', JSON.stringify(debugData));
                    updateDebugDisplay();
                }
            });
            
            // Handle timer updates
            window.addEventListener('message', (event) => {
                if (event.data.action === 'timerUpdate') {
                    const timerEntry = {
                        username: event.data.username,
                        elapsedTime: event.data.elapsedTime,
                        timestamp: new Date(event.data.timestamp).toLocaleString(),
                        currentPage: event.data.currentPage,
                        type: 'timerUpdate'
                    };
                    debugData.push(timerEntry);
                    localStorage.setItem('debugData', JSON.stringify(debugData));
                    updateDebugDisplay();
                }
            });
            
            function updateDebugDisplay() {
                const debugList = document.getElementById('debug-list');
                if (debugList) {
                    debugList.innerHTML = debugData.map(entry => {
                        if (entry.type === 'timerUpdate') {
                            return `<li>${entry.username} - Timer updated: ${entry.elapsedTime}ms at ${entry.timestamp} (${entry.currentPage})</li>`;
                        }
                        return `<li>${entry.username} - ${entry.type} at ${entry.exitTime}</li>`;
                    }).join('');
                }
            }
        });
    </script>
    <div id="debug-container">
        <h2>Debug Information</h2>
        <ul id="debug-list">
            <!-- Debug entries will appear here -->
        </ul>
    </div>
</body>
</html>